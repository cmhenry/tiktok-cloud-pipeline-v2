---
# Full Site Deployment
# Deploys all components of the audio processing pipeline
#
# Usage:
#   ansible-playbook playbooks/site.yml --ask-vault-pass
#   ansible-playbook playbooks/site.yml --vault-password-file ~/.vault_pass

- name: Deploy common configuration to all hosts
  hosts: all
  become: yes
  roles:
    - common
  tags: [common]

- name: Deploy orchestrator (Redis, PostgreSQL)
  hosts: orchestrator
  become: yes
  roles:
    - orchestrator
  tags: [orchestrator]

- name: Deploy GPU workers
  hosts: gpu_workers
  become: yes
  roles:
    - gpu_worker
  tags: [gpu_workers]

- name: Deploy transfer workers
  hosts: transfer
  become: yes
  roles:
    - transfer
  tags: [transfer]

- name: Verify deployment
  hosts: all
  become: yes
  tasks:
    - name: Check systemd services
      systemd:
        name: "{{ item }}"
      loop: "{{ services_to_check | default([]) }}"
      register: service_status
      failed_when: false
      tags: [verify]

    - name: Report service status
      debug:
        msg: "{{ item.item }}: {{ item.status.ActiveState | default('not found') }}"
      loop: "{{ service_status.results }}"
      when: service_status.results is defined
      tags: [verify]
  vars:
    services_to_check: "{{
      (groups['orchestrator'] | intersect([inventory_hostname]) | length > 0) | ternary(['redis-server', 'postgresql'], []) +
      (groups['gpu_workers'] | intersect([inventory_hostname]) | length > 0) | ternary(['gpu-worker', 'unpack-worker'], []) +
      (groups['transfer'] | intersect([inventory_hostname]) | length > 0) | ternary(['transfer-worker'], [])
    }}"
