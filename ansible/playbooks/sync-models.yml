---
# Sync Models to GPU Workers
# Re-syncs ML models from orchestrator to GPU workers
#
# Usage:
#   ansible-playbook playbooks/sync-models.yml
#   ansible-playbook playbooks/sync-models.yml --limit gpu-01
#   ansible-playbook playbooks/sync-models.yml --tags whisperx

- name: Sync models to GPU workers
  hosts: gpu_workers
  become: yes

  pre_tasks:
    - name: Stop workers before sync
      systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - gpu-worker
        - unpack-worker
      tags: [services]

    - name: Show pre-sync model sizes
      command: du -sh {{ item }}
      loop:
        - "{{ whisperx_model_path }}"
        - "{{ gemma_model_path }}"
        - "{{ cope_adapter_path }}"
      register: pre_sync_sizes
      changed_when: false
      failed_when: false
      tags: [info]

    - name: Display pre-sync sizes
      debug:
        msg: "{{ pre_sync_sizes.results | map(attribute='stdout') | list }}"
      tags: [info]

  tasks:
    - name: Sync models
      include_tasks: ../roles/gpu_worker/tasks/models.yml
      tags: [models]

  post_tasks:
    - name: Show post-sync model sizes
      command: du -sh {{ item }}
      loop:
        - "{{ whisperx_model_path }}"
        - "{{ gemma_model_path }}"
        - "{{ cope_adapter_path }}"
      register: post_sync_sizes
      changed_when: false
      tags: [info]

    - name: Display post-sync sizes
      debug:
        msg: "{{ post_sync_sizes.results | map(attribute='stdout') | list }}"
      tags: [info]

    - name: Start workers after sync
      systemd:
        name: "{{ item }}"
        state: started
      loop:
        - gpu-worker
        - unpack-worker
      tags: [services]

    - name: Wait for workers to initialize
      pause:
        seconds: 10
      tags: [services]

    - name: Verify workers are running
      systemd:
        name: "{{ item }}"
      loop:
        - gpu-worker
        - unpack-worker
      register: service_status
      tags: [verify]

    - name: Show worker status
      debug:
        msg: "{{ item.item }}: {{ item.status.ActiveState }}"
      loop: "{{ service_status.results }}"
      tags: [verify]
