---
# Transfer Worker Role
# Deploys the transfer worker that pulls archives from AWS EC2 and uploads to S3

- name: Install transfer worker dependencies
  apt:
    name:
      - openssh-client
      - python3-venv
    state: present
  tags: [packages]

- name: Clone pipeline repository
  git:
    repo: "{{ pipeline_repo }}"
    dest: "{{ pipeline_dir }}"
    version: main
    force: yes
  become_user: "{{ app_user }}"
  tags: [code]

- name: Create Python virtual environment
  command: python3 -m venv {{ pipeline_venv }}
  args:
    creates: "{{ pipeline_venv }}/bin/activate"
  become_user: "{{ app_user }}"
  tags: [venv]

- name: Install Python requirements
  pip:
    requirements: "{{ pipeline_dir }}/requirements.txt"
    virtualenv: "{{ pipeline_venv }}"
  become_user: "{{ app_user }}"
  tags: [venv]

- name: Ensure SSH directory exists
  file:
    path: "/home/{{ app_user }}/.ssh"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0700'
  tags: [ssh]

- name: Copy SSH config for transfer (if exists)
  copy:
    src: "{{ ssh_config_source | default('/dev/null') }}"
    dest: "/home/{{ app_user }}/.ssh/config"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0600'
  when: ssh_config_source is defined
  tags: [ssh]

- name: Create staging directory for transfers
  file:
    path: "{{ transfer_staging_dir | default('/tmp/transfer_staging') }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  tags: [directories]

- name: Deploy transfer worker service
  template:
    src: "{{ role_path }}/../orchestrator/templates/transfer-worker.service.j2"
    dest: /etc/systemd/system/transfer-worker.service
    mode: '0644'
  notify: Reload systemd
  tags: [services]

- name: Enable and start transfer worker service
  systemd:
    name: transfer-worker
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [services]
