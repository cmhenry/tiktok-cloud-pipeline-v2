---
# Orchestrator Role - Main Entry Point
# Deploys Redis, PostgreSQL, and optionally the RA Flask App

- name: Install orchestrator packages
  apt:
    name: "{{ orchestrator_packages }}"
    state: present
  tags: [packages]

# Redis Configuration
- name: Configure Redis to listen on all interfaces
  lineinfile:
    path: /etc/redis/redis.conf
    regexp: '^bind '
    line: "bind {{ redis_bind_address }}"
  notify: Restart redis
  tags: [redis]

- name: Configure Redis maxmemory
  lineinfile:
    path: /etc/redis/redis.conf
    regexp: '^maxmemory '
    line: "maxmemory {{ redis_maxmemory }}"
  notify: Restart redis
  tags: [redis]

- name: Configure Redis maxmemory-policy
  lineinfile:
    path: /etc/redis/redis.conf
    regexp: '^maxmemory-policy '
    line: "maxmemory-policy {{ redis_maxmemory_policy }}"
  notify: Restart redis
  tags: [redis]

- name: Enable and start Redis
  systemd:
    name: redis-server
    enabled: yes
    state: started
  tags: [redis]

# PostgreSQL Configuration
- name: Configure PostgreSQL to listen on all interfaces
  lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: '^#?listen_addresses'
    line: "listen_addresses = '{{ postgresql_listen_addresses }}'"
  notify: Restart postgresql
  tags: [postgresql]

- name: Configure PostgreSQL max connections
  lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp: '^#?max_connections'
    line: "max_connections = {{ postgresql_max_connections }}"
  notify: Restart postgresql
  tags: [postgresql]

- name: Allow remote PostgreSQL connections in pg_hba.conf
  lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf
    line: "host    all             all             10.0.0.0/8              md5"
    insertafter: '^# IPv4 local connections'
  notify: Restart postgresql
  tags: [postgresql]

- name: Enable and start PostgreSQL
  systemd:
    name: postgresql
    enabled: yes
    state: started
  tags: [postgresql]

- name: Create pipeline database
  become_user: postgres
  postgresql_db:
    name: "{{ postgres_db }}"
    state: present
  tags: [postgresql]

- name: Create pipeline database user
  become_user: postgres
  postgresql_user:
    db: "{{ postgres_db }}"
    name: "{{ postgres_user }}"
    password: "{{ postgres_password }}"
    priv: ALL
    state: present
  tags: [postgresql]

- name: Copy database schema file
  copy:
    src: schema.sql
    dest: /tmp/schema.sql
    mode: '0644'
  tags: [postgresql, schema]

- name: Apply database schema
  become_user: postgres
  postgresql_query:
    db: "{{ postgres_db }}"
    path_to_script: /tmp/schema.sql
  register: schema_result
  changed_when: false
  failed_when: false
  tags: [postgresql, schema]

# Model storage directory (source for GPU workers)
- name: Create model storage directory
  file:
    path: "{{ model_storage_mount }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  tags: [models]

# RA Flask App (optional)
- name: Deploy RA Flask App
  include_tasks: ra_app.yml
  when: ra_app_enabled
  tags: [ra_app]
