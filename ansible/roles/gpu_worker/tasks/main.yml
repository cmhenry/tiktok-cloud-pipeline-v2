---
# GPU Worker Role - Main Entry Point

- name: Install GPU worker packages
  apt:
    name: "{{ gpu_packages }}"
    state: present
  tags: [packages]

- name: Setup data volume
  include_tasks: volume.yml
  tags: [volume]

- name: Clone pipeline repository
  git:
    repo: "{{ pipeline_repo }}"
    dest: "{{ pipeline_dir }}"
    version: main
    force: yes
  become_user: "{{ app_user }}"
  tags: [code]

- name: Create Python virtual environment
  command: python3 -m venv {{ pipeline_venv }}
  args:
    creates: "{{ pipeline_venv }}/bin/activate"
  become_user: "{{ app_user }}"
  tags: [venv]

- name: Install Python requirements
  pip:
    requirements: "{{ pipeline_dir }}/requirements.txt"
    virtualenv: "{{ pipeline_venv }}"
  become_user: "{{ app_user }}"
  tags: [venv]

- name: Install GPU-specific Python packages
  pip:
    name:
      - torch>=2.1.0
      - transformers>=4.36.0
      - peft>=0.7.0
      - bitsandbytes>=0.41.0
      - whisperx>=3.1.1
    virtualenv: "{{ pipeline_venv }}"
  become_user: "{{ app_user }}"
  tags: [venv, gpu]

- name: Sync models from orchestrator
  include_tasks: models.yml
  tags: [models]

- name: Deploy GPU worker service
  template:
    src: gpu-worker.service.j2
    dest: /etc/systemd/system/gpu-worker.service
    mode: '0644'
  notify: Reload systemd
  tags: [services]

- name: Deploy unpack worker service
  template:
    src: unpack-worker.service.j2
    dest: /etc/systemd/system/unpack-worker.service
    mode: '0644'
  notify: Reload systemd
  tags: [services]

- name: Enable and start GPU worker service
  systemd:
    name: gpu-worker
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [services]

- name: Enable and start unpack worker service
  systemd:
    name: unpack-worker
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [services]

- name: Setup scratch cleanup cron
  cron:
    name: "Cleanup old scratch directories"
    minute: "0"
    hour: "*"
    job: "find {{ scratch_root }} -maxdepth 1 -type d -mmin +{{ scratch_cleanup_age_minutes }} -exec rm -rf {} +"
    user: "{{ app_user }}"
    state: "{{ 'present' if scratch_cleanup_enabled else 'absent' }}"
  tags: [cron]
